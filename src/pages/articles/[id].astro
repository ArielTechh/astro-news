---
// src/pages/articles/[id].astro
import BaseLayout from "@/layouts/base.astro";
import ContentLayout from "@/layouts/content.astro";
import ArticleHeader from "./_components/article-header.astro";
import { getAllArticles, getArticleBySlug, urlFor } from "@/lib/sanity";
import StructuredData from "@/components/seo/StructuredData.astro";

export const getStaticPaths = async () => {
  const articles = await getAllArticles();

  return articles.map((article) => ({
    params: { id: article.slug.current },
    props: { article },
  }));
};

const { article } = Astro.props;

// Récupérer l'article complet avec le contenu
const fullArticle = await getArticleBySlug(article.slug.current);

// Calcul approximatif du temps de lecture
const calculateReadingTime = (content) => {
  if (!content) return 1;

  let wordCount = 0;
  content.forEach((block) => {
    if (block._type === "block" && block.children) {
      block.children.forEach((child) => {
        if (child.text) {
          wordCount += child.text.split(" ").length;
        }
      });
    }
  });

  const wordsPerMinute = 200;
  return Math.ceil(wordCount / wordsPerMinute) || 1;
};

const readingTime = calculateReadingTime(fullArticle.content);
---

<BaseLayout entry={fullArticle} article={fullArticle} readingTime={readingTime}>
  <ArticleHeader article={fullArticle} readingTime={readingTime} />
  <ContentLayout>
    <!-- Rendu du contenu Sanity avec Portable Text -->
    <div class="prose prose-lg max-w-none">
      {
        fullArticle.content &&
          fullArticle.content.map((block, index) => {
            // Calculer la position pour insérer l'AdSense au milieu
            const totalBlocks = fullArticle.content.length;
            const midPoint = Math.floor(totalBlocks / 2);
            const shouldShowAd = index === midPoint;

            if (block._type === "block") {
              // Récupérer le contenu texte
              const textContent =
                block.children?.map((child) => {
                  let text = child.text || "";

                  // Appliquer le formatage simple
                  if (child.marks?.includes("strong")) {
                    return <strong>{text}</strong>;
                  } else if (child.marks?.includes("em")) {
                    return <em>{text}</em>;
                  } else {
                    return text;
                  }
                }) || [];

              // Rendu basé sur le style
              if (block.style === "h1") {
                return (
                  <Fragment key={index}>
                    {shouldShowAd && (
                      <div class="my-8 not-prose flex justify-center">
                        <div class="w-full max-w-2xl">
                          <script
                            async
                            src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1113800966089168"
                            crossorigin="anonymous"
                          />
                          <ins
                            class="adsbygoogle"
                            style="display:block"
                            data-ad-client="ca-pub-1113800966089168"
                            data-ad-slot="3535803759"
                            data-ad-format="auto"
                            data-full-width-responsive="true"
                          />
                          <script>
                            (adsbygoogle = window.adsbygoogle || []).push({});
                          </script>
                        </div>
                      </div>
                    )}

                    <h1 class="text-3xl font-bold mt-10 mb-5 text-gray-900">
                      {textContent}
                    </h1>
                  </Fragment>
                );
              } else if (block.style === "h2") {
                return (
                  <Fragment key={index}>
                    {shouldShowAd && (
                      <div class="my-8 not-prose flex justify-center">
                        <div class="w-full max-w-2xl">
                          <script
                            async
                            src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1113800966089168"
                            crossorigin="anonymous"
                          />
                          <ins
                            class="adsbygoogle"
                            style="display:block"
                            data-ad-client="ca-pub-1113800966089168"
                            data-ad-slot="3535803759"
                            data-ad-format="auto"
                            data-full-width-responsive="true"
                          />
                          <script>
                            (adsbygoogle = window.adsbygoogle || []).push({});
                          </script>
                        </div>
                      </div>
                    )}

                    <h2 class="text-2xl font-semibold mt-8 mb-4 text-gray-900">
                      {textContent}
                    </h2>
                  </Fragment>
                );
              } else if (block.style === "h3") {
                return (
                  <Fragment key={index}>
                    {shouldShowAd && (
                      <div class="my-8 not-prose flex justify-center">
                        <div class="w-full max-w-2xl">
                          <script
                            async
                            src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1113800966089168"
                            crossorigin="anonymous"
                          />
                          <ins
                            class="adsbygoogle"
                            style="display:block"
                            data-ad-client="ca-pub-1113800966089168"
                            data-ad-slot="3535803759"
                            data-ad-format="auto"
                            data-full-width-responsive="true"
                          />
                          <script>
                            (adsbygoogle = window.adsbygoogle || []).push({});
                          </script>
                        </div>
                      </div>
                    )}

                    <h3 class="text-xl font-medium mt-6 mb-3 text-gray-900">
                      {textContent}
                    </h3>
                  </Fragment>
                );
              } else if (block.style === "h4") {
                return (
                  <Fragment key={index}>
                    {shouldShowAd && (
                      <div class="my-8 not-prose flex justify-center">
                        <div class="w-full max-w-2xl">
                          <script
                            async
                            src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1113800966089168"
                            crossorigin="anonymous"
                          />
                          <ins
                            class="adsbygoogle"
                            style="display:block"
                            data-ad-client="ca-pub-1113800966089168"
                            data-ad-slot="3535803759"
                            data-ad-format="auto"
                            data-full-width-responsive="true"
                          />
                          <script>
                            (adsbygoogle = window.adsbygoogle || []).push({});
                          </script>
                        </div>
                      </div>
                    )}

                    <h4 class="text-lg font-medium mt-5 mb-2 text-gray-900">
                      {textContent}
                    </h4>
                  </Fragment>
                );
              } else if (block.style === "h5") {
                return (
                  <Fragment key={index}>
                    {shouldShowAd && (
                      <div class="my-8 not-prose flex justify-center">
                        <div class="w-full max-w-2xl">
                          <script
                            async
                            src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1113800966089168"
                            crossorigin="anonymous"
                          />
                          <ins
                            class="adsbygoogle"
                            style="display:block"
                            data-ad-client="ca-pub-1113800966089168"
                            data-ad-slot="3535803759"
                            data-ad-format="auto"
                            data-full-width-responsive="true"
                          />
                          <script>
                            (adsbygoogle = window.adsbygoogle || []).push({});
                          </script>
                        </div>
                      </div>
                    )}

                    <h5 class="text-base font-medium mt-4 mb-2 text-gray-900">
                      {textContent}
                    </h5>
                  </Fragment>
                );
              } else if (block.style === "h6") {
                return (
                  <Fragment key={index}>
                    {shouldShowAd && (
                      <div class="my-8 not-prose flex justify-center">
                        <div class="w-full max-w-2xl">
                          <script
                            async
                            src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1113800966089168"
                            crossorigin="anonymous"
                          />
                          <ins
                            class="adsbygoogle"
                            style="display:block"
                            data-ad-client="ca-pub-1113800966089168"
                            data-ad-slot="3535803759"
                            data-ad-format="auto"
                            data-full-width-responsive="true"
                          />
                          <script>
                            (adsbygoogle = window.adsbygoogle || []).push({});
                          </script>
                        </div>
                      </div>
                    )}

                    <h6 class="text-sm font-medium mt-3 mb-2 text-gray-900">
                      {textContent}
                    </h6>
                  </Fragment>
                );
              } else if (block.style === "blockquote") {
                return (
                  <Fragment key={index}>
                    {shouldShowAd && (
                      <div class="my-8 not-prose flex justify-center">
                        <div class="w-full max-w-2xl">
                          <script
                            async
                            src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1113800966089168"
                            crossorigin="anonymous"
                          />
                          <ins
                            class="adsbygoogle"
                            style="display:block"
                            data-ad-client="ca-pub-1113800966089168"
                            data-ad-slot="3535803759"
                            data-ad-format="auto"
                            data-full-width-responsive="true"
                          />
                          <script>
                            (adsbygoogle = window.adsbygoogle || []).push({});
                          </script>
                        </div>
                      </div>
                    )}

                    <blockquote class="border-l-4 border-blue-500 pl-6 my-6 italic text-gray-700 bg-gray-50 py-4 rounded-r">
                      {textContent}
                    </blockquote>
                  </Fragment>
                );
              } else {
                // Paragraphe normal
                return (
                  <Fragment key={index}>
                    {shouldShowAd && (
                      <div class="my-8 not-prose flex justify-center">
                        <div class="w-full max-w-2xl">
                          <script
                            async
                            src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1113800966089168"
                            crossorigin="anonymous"
                          />
                          <ins
                            class="adsbygoogle"
                            style="display:block"
                            data-ad-client="ca-pub-1113800966089168"
                            data-ad-slot="3535803759"
                            data-ad-format="auto"
                            data-full-width-responsive="true"
                          />
                          <script>
                            (adsbygoogle = window.adsbygoogle || []).push({});
                          </script>
                        </div>
                      </div>
                    )}

                    <p class="mb-4 leading-relaxed text-gray-800">
                      {textContent}
                    </p>
                  </Fragment>
                );
              }
            }

            if (block._type === "image") {
              try {
                // Vérifier que l'image a un asset valide avant de générer l'URL
                if (block.asset || block._ref) {
                  const imageUrl = urlFor(block).width(800).url();
                  return (
                    <Fragment key={index}>
                      {shouldShowAd && (
                        <div class="my-8 not-prose flex justify-center">
                          <div class="w-full max-w-2xl">
                            <script
                              async
                              src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1113800966089168"
                              crossorigin="anonymous"
                            />
                            <ins
                              class="adsbygoogle"
                              style="display:block"
                              data-ad-client="ca-pub-1113800966089168"
                              data-ad-slot="3535803759"
                              data-ad-format="auto"
                              data-full-width-responsive="true"
                            />
                            <script>
                              (adsbygoogle = window.adsbygoogle || []).push({});
                            </script>
                          </div>
                        </div>
                      )}

                      <div class="my-8">
                        <img
                          src={imageUrl}
                          alt={block.alt || "Image de l'article"}
                          class="w-full rounded-lg shadow-md"
                          loading="lazy"
                        />
                      </div>
                    </Fragment>
                  );
                } else {
                  // Image sans asset valide - ne pas la rendre
                  console.warn(
                    "Image sans asset trouvée dans [id].astro, ignorée:",
                    block,
                  );
                  return null;
                }
              } catch (error) {
                // Si erreur dans la génération de l'URL, ne pas rendre l'image
                console.warn(
                  "Erreur lors du rendu de l'image dans [id].astro:",
                  error,
                  block,
                );
                return null;
              }
            }

            return null;
          })
      }
    </div>
  </ContentLayout>
</BaseLayout>
