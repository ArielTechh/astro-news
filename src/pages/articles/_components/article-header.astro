---
// src/pages/articles/_components/article-header.astro
import { Image, Picture } from "astro:assets";
import { formatDate, normalizeDate } from "@/lib/utils/date";
import ResourcesAdd from "@/assets/svgs/resources-add.astro";
import Time04 from "@/assets/svgs/time-04.astro";
import Calendar04 from "@/assets/svgs/calendar-04.astro";
import Divider from "@/components/bases/divider.astro";
import Share from "@/components/elements/share.astro";
import { urlFor } from "@/lib/sanity";

type Props = {
  article: {
    _id: string;
    title: string;
    description: string;
    slug: { current: string };
    cover?: any;
    publishedTime: string;
    categories?: Array<{
      title: string;
      slug: { current: string };
      parent?: {
        title: string;
        slug: { current: string };
      };
    }>;
    authors?: Array<{
      name: string;
      slug: { current: string };
      bio?: string;
      avatar?: any;
    }>;
  };
  readingTime: number;
};

const { article, readingTime } = Astro.props;

const category = article.categories?.[0];
const authors = article.authors || [];

// üöÄ IMAGES OPTIMIS√âES AVEC TAILLES RESPONSIVES
const coverImages = article.cover
  ? {
      // Mobile : 412x206 (ratio d√©tect√© par Lighthouse)
      mobile: urlFor(article.cover)
        .width(412)
        .height(206)
        .format("webp")
        .quality(70)
        .url(),

      // Tablet : 768x384
      tablet: urlFor(article.cover)
        .width(768)
        .height(384)
        .format("webp")
        .quality(70)
        .url(),

      // Desktop : 1024x512 (max n√©cessaire)
      desktop: urlFor(article.cover)
        .width(1024)
        .height(512)
        .format("webp")
        .quality(70)
        .url(),

      // Fallback JPEG pour compatibilit√©
      fallback: urlFor(article.cover)
        .width(1024)
        .height(512)
        .format("jpg")
        .quality(65)
        .url(),
    }
  : null;

// Fonction pour formater la date en dd/mm/yyyy avec timezone Jerusalem
const formatJerusalemDate = (dateString) => {
  const date = new Date(dateString);
  const jerusalemDate = new Date(
    date.toLocaleString("en-US", { timeZone: "Asia/Jerusalem" }),
  );

  const day = jerusalemDate.getDate().toString().padStart(2, "0");
  const month = (jerusalemDate.getMonth() + 1).toString().padStart(2, "0");
  const year = jerusalemDate.getFullYear();

  return `${day}/${month}/${year}`;
};
---

<section
  class="mb-8 flex flex-col lg:flex-col-reverse border-b border-b-base-300 lg:border-none pb-4 pt-0 lg:pt-6"
>
  <div
    class="container px-0 max-w-5xl lg:mt-4 overflow-hidden aspect-[20/9] rounded-md"
  >
    {
      coverImages && (
        <picture>
          {/* WebP pour les navigateurs modernes */}
          <source
            media="(max-width: 480px)"
            srcset={coverImages.mobile}
            type="image/webp"
          />
          <source
            media="(max-width: 768px)"
            srcset={coverImages.tablet}
            type="image/webp"
          />
          <source
            media="(min-width: 769px)"
            srcset={coverImages.desktop}
            type="image/webp"
          />

          {/* Fallback JPEG */}
          <img
            src={coverImages.fallback}
            alt={article.title}
            width="1024"
            height="512"
            loading="eager"
            fetchpriority="high"
            decoding="async"
            class="w-full h-full object-cover object-center"
            sizes="(max-width: 480px) 412px, (max-width: 768px) 768px, 1024px"
          />
        </picture>
      )
    }
  </div>

  {
    category && (
      <div class="container my-4 max-w-5xl lg:hidden flex items-center gap-2">
        <ResourcesAdd size="16" />
        <a
          href={`/categories/${category.slug.current}`}
          class="a-01 font-semibold"
        >
          {category.title}
        </a>
      </div>
    )
  }

  <div class="container max-w-5xl">
    <h1 class="text-3xl lg:text-4xl font-bold text-right text-pretty">
      {article.title}
    </h1>
    <div class="flex flex-col gap-4 items-start mt-2 lg:mt-6 text-sm">
      <div class="text-base-content/70 flex items-center gap-2">
        {
          category && (
            <>
              <span class="hidden lg:flex items-center gap-1">
                <ResourcesAdd size="15" />
                <a
                  href={`/categories/${category.slug.current}`}
                  class="a-01 font-semibold"
                >
                  {category.title}
                </a>
              </span>
              <Divider responsive />
            </>
          )
        }

        <span class="flex items-center gap-1">
          <Calendar04 size="15" />
          <time datetime={normalizeDate(article.publishedTime)}>
            {formatJerusalemDate(article.publishedTime)}
          </time>
        </span>
        <Divider />
        <span class="flex items-center gap-1">
          <Time04 size="15" />
          <span>{readingTime} ◊ì◊ß' ◊ß◊®◊ô◊ê◊î</span>
        </span>
      </div>

      <div class="w-full flex flex-wrap gap-2 items-center justify-between">
        <div class="flex flex-wrap gap-4">
          {
            authors.map((author) => (
              <div class="flex items-center gap-2">
                <span class="flex items-center gap-2">
                  <div class="avatar">
                    <div class="w-8 rounded-full">
                      {author.avatar ? (
                        <img
                          src={urlFor(author.avatar)
                            .width(48)
                            .height(48)
                            .format("webp")
                            .quality(80)
                            .url()}
                          alt={author.name}
                          width="48"
                          height="48"
                          loading="lazy"
                          decoding="async"
                          class="rounded-full"
                        />
                      ) : (
                        <div class="w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center">
                          <span class="text-xs font-bold">
                            {author.name.charAt(0).toUpperCase()}
                          </span>
                        </div>
                      )}
                    </div>
                  </div>
                  <span class="font-bold capitalize">{author.name}</span>
                </span>
              </div>
            ))
          }
        </div>
        <Share text={article.title} />
      </div>
    </div>
  </div>
</section>
