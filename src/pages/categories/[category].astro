---
// src/pages/categories/[category].astro - PAGE 1 PROPRE
import type { GetStaticPaths } from "astro";
import { SITE } from "@/lib/config";
import { getAllCategories, getArticlesByCategory } from "@/lib/sanity";
import ListLayout from "@/layouts/list.astro";
import Pagination from "@/components/shared/pagination.astro";
import WideCard from "@/components/cards/wideCard.astro";

export const getStaticPaths = (async () => {
  const allCategories = await getAllCategories();

  const paths = [];

  for (const category of allCategories) {
    // Vérifier qu'il y a des articles dans cette catégorie
    const articles = await getArticlesByCategory(category.slug.current);

    if (articles.length > 0) {
      paths.push({
        params: { category: category.slug.current },
        props: {
          categoryInfo: category,
          allArticles: articles, // ✅ Passer tous les articles
        },
      });
    }
  }

  return paths;
}) satisfies GetStaticPaths;

const { categoryInfo, allArticles } = Astro.props;
const { category } = Astro.params;

// ✅ Utiliser les articles passés en props
const totalArticles = allArticles.length;

// Pagination pour page 1
const articlesPerPage = SITE.postsPerPage;
const articles = allArticles.slice(0, articlesPerPage);
const totalPages = Math.ceil(totalArticles / articlesPerPage);

// Métadonnées pour la catégorie (page 1)
const categoryMeta = {
  title: `מאמרים בנושא ${categoryInfo.title}`,
  metaTitle: `מאמרים בנושא ${categoryInfo.title}`,
  description:
    categoryInfo.description ||
    `כל המאמרים והביקורות בנושא ${categoryInfo.title}`,
  type: "website",
};

const categoryEntry = {
  id: "category-page",
  collection: "views",
  data: categoryMeta,
};

const canonicalUrl = `${SITE.url}/categories/${category}`;
---

<ListLayout
  header={categoryInfo.title}
  entry={categoryEntry}
  canonical={canonicalUrl}
  customMeta={categoryMeta}
>
  <div dir="rtl">
    <!-- Breadcrumb -->
    {
      categoryInfo?.parent && (
        <nav class="mb-6 text-sm" dir="rtl">
          <a href="/categories" class="text-blue-600 hover:underline">
            כל הקטגוריות
          </a>
          <span class="mx-2">←</span>
          <a
            href={`/categories/${categoryInfo.parent.slug.current}`}
            class="text-blue-600 hover:underline"
          >
            {categoryInfo.parent.title}
          </a>
          <span class="mx-2">←</span>
          <span class="text-gray-600">{categoryInfo.title}</span>
        </nav>
      )
    }

    <!-- Compteur d'articles -->
    <div class="mb-6 text-sm text-gray-600" dir="rtl">
      <span>{totalArticles} מאמרים בקטגוריה זו</span>
    </div>

    <!-- Liste des articles -->
    <ul class="flex flex-col gap-2 flex-1">
      {
        articles.map((article, index) => (
          <WideCard article={article} isLast={index === articles.length - 1} />
        ))
      }
    </ul>

    <!-- Pagination (seulement si plus d'1 page) -->
    {
      totalPages > 1 && (
        <div dir="ltr" class="mt-8">
          <Pagination
            length={totalPages}
            currentUrl={`/categories/${category}`}
            currentPage={1}
            baseUrl={`/categories/${category}`}
            prevUrl={null}
            nextUrl={`/categories/${category}/2`}
            lastUrl={`/categories/${category}/${totalPages}`}
          />
        </div>
      )
    }
  </div>
</ListLayout>
