---
// src/pages/categories/[category]/[page].astro
import type { GetStaticPaths } from "astro";
import { SITE } from "@/lib/config";
import { getAllCategories, getArticlesByCategory } from "@/lib/sanity";
import ListLayout from "@/layouts/list.astro";
import Pagination from "@/components/shared/pagination.astro";
import WideCard from "@/components/cards/wideCard.astro";
import { getEntry } from "astro:content";

export const getStaticPaths = (async ({ paginate }) => {
  // Récupérer toutes les catégories depuis Sanity
  const allCategories = await getAllCategories();

  const allPaths = [];

  for (const category of allCategories) {
    // Récupérer les articles de cette catégorie
    const categoryArticles = await getArticlesByCategory(category.slug.current);

    if (categoryArticles.length > 0) {
      // Créer les pages paginées pour cette catégorie
      const paginatedPaths = paginate(categoryArticles, {
        params: { category: category.slug.current },
        props: {
          postsLength: categoryArticles.length,
          categoryInfo: category,
        },
        pageSize: SITE.postsPerPage,
      });

      allPaths.push(...paginatedPaths);
      
      // Ajouter une route pour /categories/{category} (sans numéro) qui redirige vers /1
      allPaths.push({
        params: { category: category.slug.current, page: "index" },
        props: {
          postsLength: categoryArticles.length,
          categoryInfo: category,
          shouldRedirect: true,
          redirectTo: `/categories/${category.slug.current}/1`
        }
      });
    }
  }

  return allPaths;
}) satisfies GetStaticPaths;

const { page, shouldRedirect, redirectTo } = Astro.props;
const { postsLength, categoryInfo } = Astro.props;
const params = Astro.params;

const articles = page?.data || [];
const pathname = new URL(Astro.request.url).pathname.split("/");
const basePath = `${pathname[1]}/${pathname[2]}`;

const entry = await getEntry("views", "categories");

if (!entry) {
  return Astro.redirect("/404");
}

// Titre de la catégorie en hébreu ou utiliser le titre Sanity
const categoryTitle = categoryInfo?.title || params.category;

// Redirection si nécessaire
if (shouldRedirect && redirectTo) {
  const canonicalUrl = `${SITE.url}${redirectTo}`;
  const meta = {
    title: `${categoryInfo?.title || params.category} - עמוד 1`,
    description: `מאמרים בקטגוריה ${categoryInfo?.title || params.category} - Tech Horizons`,
    type: "website" as const,
    ogImage: entry?.data?.ogImage || "/default-og.jpg",
    ogImageAlt: `${categoryInfo?.title || params.category} - Tech Horizons`
  };
  
  const redirectHtml = `<!doctype html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>${meta.title} | ${SITE.title}</title>
    <meta name="description" content="${meta.description}" />
    <link rel="canonical" href="${canonicalUrl}" />
    <meta name="robots" content="noindex" />
    <meta http-equiv="refresh" content="0; url=${redirectTo}" />
    <meta property="og:title" content="${meta.title} | ${SITE.title}" />
    <meta property="og:description" content="${meta.description}" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="${canonicalUrl}" />
    <meta property="og:site_name" content="${SITE.title}" />
    <meta property="og:locale" content="he_IL" />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="${meta.title} | ${SITE.title}" />
    <meta name="twitter:description" content="${meta.description}" />
  </head>
  <body>
    <script>window.location.replace("${redirectTo}");</script>
    <noscript>
      <div style="text-align: center; padding: 2rem;" dir="rtl">
        <h1>מעביר אותך לעמוד ${categoryInfo?.title || params.category}</h1>
        <p>אם לא הועברת אוטומטית, <a href="${redirectTo}">לחץ כאן</a></p>
      </div>
    </noscript>
  </body>
</html>`;
  
  return new Response(redirectHtml, {
    status: 200,
    headers: {
      'Content-Type': 'text/html; charset=utf-8',
    },
  });
}

// ✅ AJOUT : URL canonique SANS slash final
const canonicalUrl = `${SITE.url}/categories/${params.category}/${page.currentPage}`;
---

<ListLayout header={categoryTitle} entry={entry} canonical={canonicalUrl}>
  <div dir="rtl">
    <!-- Breadcrumb pour catégories hiérarchiques -->
    {
      categoryInfo?.parent && (
        <nav class="mb-6 text-sm" dir="rtl">
          <a href="/categories" class="text-blue-600 hover:underline">
            כל הקטגוריות
          </a>
          <span class="mx-2">←</span>
          <a
            href={`/categories/${categoryInfo.parent.slug.current}/1`}
            class="text-blue-600 hover:underline"
          >
            {categoryInfo.parent.title}
          </a>
          <span class="mx-2">←</span>
          <span class="text-gray-600">{categoryInfo.title}</span>
        </nav>
      )
    }

    <!-- Compteur d'articles -->
    <div class="mb-6 text-sm text-gray-600" dir="rtl">
      <span>{postsLength} מאמרים בקטגוריה זו</span>
    </div>

    <!-- Liste des articles -->
    <ul class="flex flex-col gap-2 flex-1">
      {
        articles.map((article, index) => (
          <WideCard article={article} isLast={index === articles.length - 1} />
        ))
      }
    </ul>

    <!-- Pagination -->
    {
      postsLength > SITE.postsPerPage && (
        <div dir="ltr" class="mt-8">
          <Pagination
            length={page.lastPage}
            currentUrl={page.url.current}
            currentPage={page.currentPage}
            baseUrl={`/${basePath}`}
            prevUrl={page.url.prev}
            nextUrl={page.url.next}
            lastUrl={`/${basePath}/${page.lastPage}`}
          />
        </div>
      )
    }
  </div>
</ListLayout>
