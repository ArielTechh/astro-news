---
// src/components/seo/StructuredData.astro - VERSION PROPRE
import { urlFor } from "@/lib/sanity";

type Props = {
  article: {
    _id: string;
    title: string;
    description: string;
    slug: { current: string };
    cover?: any;
    publishedTime: string;
    content?: any[];
    categories?: Array<{
      title: string;
      slug: { current: string };
      parent?: {
        title: string;
        slug: { current: string };
      };
    }>;
    authors?: Array<{
      name: string;
      slug: { current: string };
      bio?: string;
      avatar?: any;
    }>;
  };
  readingTime?: number;
  articleType?: "NewsArticle" | "Article" | "TechArticle" | "HowTo";
};

const { article, readingTime, articleType } = Astro.props;

// ‚úÖ ANALYSER LE CONTENU POUR LES VID√âOS
const getYouTubeId = (url) => {
  if (!url) return null;
  const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
  const match = url.match(regExp);
  return (match && match[2].length === 11) ? match[2] : null;
};

const extractYouTubeFromText = (text) => {
  const match = text.match(/(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
  return match ? match[1] : null;
};

const analyzeVideos = () => {
  if (!article.content) return [];
  
  const videos = [];
  
  article.content.forEach((block) => {
    // Vid√©os avec sch√©ma YouTube
    if (block._type === "youtube" && block.url) {
      const videoId = getYouTubeId(block.url);
      if (videoId) {
        videos.push({
          "@type": "VideoObject",
          name: block.title || article.title,
          description: block.title || article.description || article.title,
          thumbnailUrl: `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`,
          embedUrl: `https://www.youtube.com/embed/${videoId}`,
          uploadDate: article.publishedTime,
          // ‚úÖ PAS DE DURATION - laisse Google la d√©tecter
          publisher: {
            "@type": "Organization",
            name: "YouTube",
            url: "https://www.youtube.com"
          }
        });
      }
    }
    
    // YouTube dans le texte brut
    if (block._type === "block" && block.children) {
      const fullText = block.children.map(child => child.text).join("");
      const youtubeId = extractYouTubeFromText(fullText);
      if (youtubeId) {
        videos.push({
          "@type": "VideoObject",
          name: article.title,
          description: article.description || article.title,
          thumbnailUrl: `https://img.youtube.com/vi/${youtubeId}/maxresdefault.jpg`,
          embedUrl: `https://www.youtube.com/embed/${youtubeId}`,
          uploadDate: article.publishedTime,
          publisher: {
            "@type": "Organization",
            name: "YouTube",
            url: "https://www.youtube.com"
          }
        });
      }
    }
  });
  
  return videos.slice(0, 3); // Max 3 vid√©os
};

const videos = analyzeVideos();

// D√©tection du type d'article
const detectArticleType = () => {
  if (articleType) return articleType;

  const hasSpecialCategory = article.categories?.some(
    (category) => category._id === "c4bbd56e-97cb-46d6-8192-9884289e8872",
  );

  if (hasSpecialCategory) {
    const howToKeywords = ["◊ê◊ô◊ö", "◊õ◊ô◊¶◊ì", "◊û◊ì◊®◊ô◊ö", "◊©◊ú◊ë◊ô◊ù", "◊î◊°◊ë◊®", "◊ú◊¢◊©◊ï◊™"];
    const isHowTo = howToKeywords.some((keyword) =>
      article.title.toLowerCase().includes(keyword),
    );
    return isHowTo ? "HowTo" : "TechArticle";
  }

  return "NewsArticle";
};

const detectedType = detectArticleType();
const siteUrl = "https://techhorizons.co.il";
const currentUrl = `${siteUrl}/${article.slug.current}`;

// Image de couverture
const coverImageUrl = article.cover
  ? urlFor(article.cover).width(1200).height(630).url()
  : `${siteUrl}/techh_logo.webp`;

// Auteurs
const authors = article.authors || [];
const authorsSchema = authors.map((author) => ({
  "@type": "Person",
  name: author.name,
  url: `${siteUrl}/authors/${author.slug.current}`,
  ...(author.avatar && {
    image: urlFor(author.avatar).width(400).height(400).url(),
  }),
}));

const mainCategory = article.categories?.[0];

const organization = {
  "@type": "Organization",
  name: "TechHorizons",
  url: siteUrl,
  logo: {
    "@type": "ImageObject",
    url: `${siteUrl}/techh_logo.webp`,
    width: 300,
    height: 300,
  },
};

// ‚úÖ SCHEMA UNIQUE ET PROPRE
const schema = {
  "@context": "https://schema.org",
  "@type": detectedType,
  headline: article.title,
  description: article.description || article.title,
  url: currentUrl,
  datePublished: article.publishedTime,
  dateModified: article.publishedTime,
  author: authorsSchema.length > 0 ? authorsSchema : organization,
  publisher: organization,
  image: {
    "@type": "ImageObject",
    url: coverImageUrl,
    width: 1200,
    height: 630,
  },
  mainEntityOfPage: {
    "@type": "WebPage",
    "@id": currentUrl,
  },
  // ‚úÖ AJOUTER LES VID√âOS DIRECTEMENT DANS L'ARTICLE
  ...(videos.length > 0 && {
    video: videos.length === 1 ? videos[0] : videos
  }),
  // Propri√©t√©s sp√©cifiques selon le type
  ...(detectedType === "NewsArticle" && {
    articleSection: mainCategory?.title || "Technology",
    inLanguage: "he-IL",
    ...(readingTime && {
      timeRequired: `PT${readingTime}M`,
    }),
  }),
  ...(detectedType === "TechArticle" && {
    genre: "Technology",
    keywords: mainCategory?.title || "Technology",
    inLanguage: "he-IL",
    ...(readingTime && {
      timeRequired: `PT${readingTime}M`,
    }),
  })
};

// Pour les HowTo, ajuster le schema
if (detectedType === "HowTo") {
  schema["@type"] = "HowTo";
  schema.name = article.title;
  delete schema.headline;
}
---

<!-- ‚úÖ UN SEUL SCHEMA - PROPRE ET COMPLET -->
<script type="application/ld+json" set:html={JSON.stringify(schema)} />

<!-- ‚úÖ META TAGS POUR LES VID√âOS -->
{videos.length > 0 && (
  <>
    <meta property="og:video" content={videos[0].embedUrl} />
    <meta property="og:video:type" content="text/html" />
    <meta property="og:video:width" content="1280" />
    <meta property="og:video:height" content="720" />
    <meta name="twitter:player" content={videos[0].embedUrl} />
    <meta name="twitter:player:width" content="1280" />
    <meta name="twitter:player:height" content="720" />
  </>
)}

<!-- ‚úÖ DEBUG (d√©veloppement seulement) -->
{import.meta.env.DEV && (
  <script>
    console.log('üìä Structured Data:', {
      type: detectedType,
      hasVideos: videos.length > 0,
      videosCount: videos.length,
      url: currentUrl
    });
  </script>
)}