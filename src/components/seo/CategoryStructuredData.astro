---
// src/components/seo/CategoryStructuredData.astro
import { urlFor } from "@/lib/sanity";

type Props = {
  categoryInfo: {
    _id: string;
    title: string;
    slug: { current: string };
    description?: string;
    parent?: {
      title: string;
      slug: { current: string };
    };
  };
  articles: Array<{
    _id: string;
    title: string;
    description: string;
    slug: { current: string };
    cover?: any;
    publishedTime: string;
    authors?: Array<{
      name: string;
      slug: { current: string };
    }>;
  }>;
  allArticles?: Array<any>;
  currentPage?: number;
  canonicalUrl: string;
};

const {
  categoryInfo,
  articles,
  allArticles = articles,
  currentPage = 1,
  canonicalUrl,
} = Astro.props;

const siteUrl = "https://techhorizons.co.il";

// Organisation
const organization = {
  "@type": "Organization",
  name: "TechHorizons",
  url: siteUrl,
  logo: {
    "@type": "ImageObject",
    url: `${siteUrl}/techh_logo.webp`,
    width: 300,
    height: 300,
  },
};

// Schema principal - CollectionPage pour catégorie
const schema = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "@id": canonicalUrl,
  name:
    currentPage > 1
      ? `${categoryInfo.title} - עמוד ${currentPage}`
      : categoryInfo.title,
  description:
    categoryInfo.description ||
    `כל המאמרים והביקורות בנושא ${categoryInfo.title}. ${allArticles.length} מאמרים בקטגוריה ${categoryInfo.title}`,
  url: canonicalUrl,
  inLanguage: "he-IL",

  mainEntity: {
    "@type": "ItemList",
    name: `מאמרים בקטגוריה ${categoryInfo.title}`,
    numberOfItems: allArticles.length,
    itemListElement: articles.map((article, index) => ({
      "@type": "ListItem",
      position: (currentPage - 1) * articles.length + index + 1,
      item: {
        "@type": "Article",
        "@id": `${siteUrl}/${article.slug.current}`,
        headline: article.title,
        description: article.description || article.title,
        url: `${siteUrl}/${article.slug.current}`,
        datePublished: article.publishedTime,
        author:
          article.authors?.map((author) => ({
            "@type": "Person",
            name: author.name,
            url: `${siteUrl}/authors/${author.slug.current}`,
          })) || organization,
        publisher: organization,
        ...(article.cover && {
          image: {
            "@type": "ImageObject",
            url: urlFor(article.cover).width(1200).height(630).url(),
            width: 1200,
            height: 630,
          },
        }),
        articleSection: categoryInfo.title,
        keywords: categoryInfo.title,
      },
    })),
  },

  isPartOf: {
    "@type": "WebSite",
    "@id": siteUrl,
    name: "TechHorizons",
    url: siteUrl,
  },

  // Breadcrumb avec support des catégories parentes
  breadcrumb: {
    "@type": "BreadcrumbList",
    itemListElement: [
      {
        "@type": "ListItem",
        position: 1,
        name: "כל הקטגוריות",
        item: `${siteUrl}/categories`,
      },
      // Catégorie parente si elle existe
      ...(categoryInfo.parent
        ? [
            {
              "@type": "ListItem",
              position: 2,
              name: categoryInfo.parent.title,
              item: `${siteUrl}/categories/${categoryInfo.parent.slug.current}`,
            },
          ]
        : []),
      {
        "@type": "ListItem",
        position: categoryInfo.parent ? 3 : 2,
        name: categoryInfo.title,
        item: `${siteUrl}/categories/${categoryInfo.slug.current}`,
      },
      // Page courante si pagination
      ...(currentPage > 1
        ? [
            {
              "@type": "ListItem",
              position: categoryInfo.parent ? 4 : 3,
              name: `עמוד ${currentPage}`,
              item: canonicalUrl,
            },
          ]
        : []),
    ],
  },

  // Relation avec la catégorie parente si elle existe
  ...(categoryInfo.parent && {
    isPartOf: [
      {
        "@type": "WebSite",
        "@id": siteUrl,
        name: "TechHorizons",
        url: siteUrl,
      },
      {
        "@type": "CollectionPage",
        "@id": `${siteUrl}/categories/${categoryInfo.parent.slug.current}`,
        name: categoryInfo.parent.title,
        url: `${siteUrl}/categories/${categoryInfo.parent.slug.current}`,
      },
    ],
  }),

  publisher: organization,
  image:
    articles.length > 0 && articles[0].cover
      ? {
          "@type": "ImageObject",
          url: urlFor(articles[0].cover).width(1200).height(630).url(),
          width: 1200,
          height: 630,
        }
      : {
          "@type": "ImageObject",
          url: `${siteUrl}/techh_logo.webp`,
          width: 300,
          height: 300,
        },
};
---

<script type="application/ld+json" set:html={JSON.stringify(schema)} />
