<!-- SOLUTION ANTI-FRUSTRATION - GARANTIE 100% --><!-- ÉTAPE 1: GTM avec consent par défaut -->
<script>
  console.log("🔥 ÉTAPE 1: Initialisation GTM");

  window.dataLayer = window.dataLayer || [];
  function gtag() {
    dataLayer.push(arguments);
  }

  // Consent REFUSÉ par défaut
  gtag("consent", "default", {
    analytics_storage: "denied",
    ad_storage: "denied",
    ad_user_data: "denied",
    ad_personalization: "denied",
    functionality_storage: "denied",
    personalization_storage: "denied",
    security_storage: "granted",
  });

  console.log("✅ Consent par défaut = DENIED");
</script>

<!-- ÉTAPE 2: Chargement GTM -->
<script>
  (function (w, d, s, l, i) {
    w[l] = w[l] || [];
    w[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
    var f = d.getElementsByTagName(s)[0],
      j = d.createElement(s),
      dl = l != "dataLayer" ? "&l=" + l : "";
    j.async = true;
    j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
    f.parentNode.insertBefore(j, f);
  })(window, document, "script", "dataLayer", "GTM-PQC6K9BZ");
</script>

<!-- ÉTAPE 3: Banner Ultra Simple -->
<div
  id="cookie-banner"
  style="position:fixed;bottom:0;left:0;right:0;background:#000;color:#fff;padding:20px;z-index:99999;text-align:center;"
>
  <p style="margin:0 0 15px 0;">
    🍪 This site uses cookies. Choose your preference:
  </p>
  <button
    id="accept-btn"
    style="background:#28a745;color:white;border:none;padding:15px 30px;margin:0 10px;border-radius:5px;font-size:16px;cursor:pointer;font-weight:bold;"
  >
    ✅ ACCEPT ALL
  </button>
  <button
    id="reject-btn"
    style="background:#dc3545;color:white;border:none;padding:15px 30px;margin:0 10px;border-radius:5px;font-size:16px;cursor:pointer;font-weight:bold;"
  >
    ❌ REJECT ALL
  </button>
</div>

<!-- ÉTAPE 4: Script ULTRA SIMPLE -->
<script>
  console.log("🔥 ÉTAPE 4: Initialisation du script de consent");

  // Fonction ACCEPT
  function forceAccept() {
    console.log("🟢 FORÇAGE ACCEPT - DÉBUT");

    // 1. Mise à jour GTM
    gtag("consent", "update", {
      analytics_storage: "granted",
      ad_storage: "granted",
      ad_user_data: "granted",
      ad_personalization: "granted",
      functionality_storage: "granted",
      personalization_storage: "granted",
    });

    // 2. Push dataLayer
    dataLayer.push({
      event: "consent_update",
      consent_analytics: "granted",
      consent_ads: "granted",
    });

    // 3. Storage
    localStorage.setItem("consent-status", "accepted");

    // 4. Masquer banner
    document.getElementById("cookie-banner").style.display = "none";

    console.log("🟢 FORÇAGE ACCEPT - TERMINÉ");
    console.log("📊 Vérification dataLayer:", dataLayer);

    // 5. Force reload GTM (dernière tentative)
    setTimeout(function () {
      dataLayer.push({ event: "gtm.dom" });
      console.log("🔄 GTM DOM event forcé");
    }, 500);
  }

  // Fonction REJECT
  function forceReject() {
    console.log("🔴 FORÇAGE REJECT");

    localStorage.setItem("consent-status", "rejected");
    document.getElementById("cookie-banner").style.display = "none";

    dataLayer.push({
      event: "consent_rejected",
    });

    console.log("🔴 REJECT terminé");
  }

  // Event Listeners
  document.addEventListener("DOMContentLoaded", function () {
    console.log("📋 DOM chargé - Ajout des event listeners");

    // Bouton Accept
    const acceptBtn = document.getElementById("accept-btn");
    if (acceptBtn) {
      acceptBtn.addEventListener("click", forceAccept);
      console.log("✅ Event listener ACCEPT ajouté");
    }

    // Bouton Reject
    const rejectBtn = document.getElementById("reject-btn");
    if (rejectBtn) {
      rejectBtn.addEventListener("click", forceReject);
      console.log("❌ Event listener REJECT ajouté");
    }

    // Vérifier si déjà accepté
    const status = localStorage.getItem("consent-status");
    if (status === "accepted") {
      console.log("🔄 Statut déjà accepté - Restauration");
      forceAccept();
    } else if (status !== "rejected") {
      // Afficher le banner seulement si pas de choix
      document.getElementById("cookie-banner").style.display = "block";
      console.log("📢 Banner affiché");
    }
  });

  // TEST MANUEL - Tapez ça dans la console après avoir cliqué Accept:
  // gtag('get', 'GTM-PQC6K9BZ', 'analytics_storage', (value) => console.log('Analytics storage:', value));
</script>

<!-- GTM noscript -->
<noscript>
  <iframe
    src="https://www.googletagmanager.com/ns.html?id=GTM-PQC6K9BZ"
    height="0"
    width="0"
    style="display:none;visibility:hidden"></iframe>
</noscript>

<!-- 
🧪 INSTRUCTIONS DE TEST:

1. Rechargez la page avec console ouverte
2. Vous DEVEZ voir: "ÉTAPE 1", "ÉTAPE 4", "DOM chargé", "Event listener ACCEPT ajouté" 
3. Cliquez sur "ACCEPT ALL"
4. Vous DEVEZ voir: "FORÇAGE ACCEPT - DÉBUT" puis "FORÇAGE ACCEPT - TERMINÉ"
5. Dans GTM Preview: Le consent DOIT passer à GRANTED

🔥 SI ÇA NE MARCHE TOUJOURS PAS:
- Tapez dans la console: dataLayer
- Tapez: gtag('get', 'GTM-PQC6K9BZ', 'analytics_storage', console.log)
- Envoyez-moi les résultats !
-->
