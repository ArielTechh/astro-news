---
// TarteAuCitron.astro - SOLUTION DÉFINITIVE CORRIGÉE V2
---

<script is:inline>
  var tarteaucitronForceLanguage = "en";

  (function () {
    var script = document.createElement("script");
    script.src =
      "https://cdn.jsdelivr.net/npm/tarteaucitronjs@1/tarteaucitron.js";
    script.onload = function () {
      tarteaucitron.init({
        privacyUrl: "/privacy-policy",
        bodyPosition: "bottom",
        hashtag: "#tarteaucitron",
        cookieName: "tarteaucitron",
        orientation: "middle",
        showDetailsOnClick: true,
        serviceDefaultState: "wait",
        DenyAllCta: true,
        AcceptAllCta: true,
        highPrivacy: true,
        showIcon: true,
        iconPosition: "BottomRight",
        showAlertSmall: true,
      });

      // ✅ Configuration GTM
      tarteaucitron.user.googletagmanagerId = "GTM-PQC6K9BZ";
      (tarteaucitron.job = tarteaucitron.job || []).push("googletagmanager");

      // ✅ Configuration Google AdSense
      tarteaucitron.user.adsensecapub = "ca-pub-1113800966089168";
      (tarteaucitron.job = tarteaucitron.job || []).push("adsenseauto");

      // ✅ SOLUTION : Écouter les événements TarteAuCitron
      document.addEventListener("tac.root_available", function () {
        console.log("TarteAuCitron root available");

        // Écouter les changements de consentement
        document.addEventListener("tac.accept_all", function () {
          console.log("Accept all triggered");
          setTimeout(function () {
            updateGTMConsent(true);
          }, 100);
        });

        document.addEventListener("tac.deny_all", function () {
          console.log("Deny all triggered");
          setTimeout(function () {
            updateGTMConsent(false);
          }, 100);
        });

        document.addEventListener("tac.service_loaded", function (e) {
          console.log("Service loaded:", e.detail);
          if (e.detail.service === "googletagmanager") {
            updateGTMConsent(true);
          }
        });
      });

      // ✅ Fonction pour mettre à jour GTM
      function updateGTMConsent(granted) {
        console.log("Updating GTM consent:", granted);

        if (window.gtag) {
          if (granted) {
            gtag("consent", "update", {
              analytics_storage: "granted",
              ad_storage: "granted",
              functionality_storage: "granted",
              personalization_storage: "granted",
              ad_user_data: "granted",
              ad_personalization: "granted",
            });
          } else {
            gtag("consent", "update", {
              analytics_storage: "denied",
              ad_storage: "denied",
              functionality_storage: "denied",
              personalization_storage: "denied",
              ad_user_data: "denied",
              ad_personalization: "denied",
            });
          }
        }

        // Push dans dataLayer aussi
        if (window.dataLayer) {
          window.dataLayer.push({
            event: "consent_update",
            consent_status: granted ? "granted" : "denied",
          });
        }
      }

      console.log("TarteAuCitron initialized with GTM consent listeners");
    };
    document.head.appendChild(script);
  })();
</script>

<!-- ✅ GTM Initialization -->
<script is:inline>
  window.dataLayer = window.dataLayer || [];
  function gtag() {
    dataLayer.push(arguments);
  }

  // Consentement par défaut refusé (attendu par GTM)
  gtag("consent", "default", {
    analytics_storage: "denied",
    ad_storage: "denied",
    functionality_storage: "denied",
    personalization_storage: "denied",
    ad_user_data: "denied",
    ad_personalization: "denied",
    security_storage: "granted",
  });

  // Debug
  console.log("GTM consent default set to denied");
</script>
