<!-- SOLUTION ULTRA SIMPLE QUI MARCHE -->
<script>
  // Variables globales
  window.consentGiven = false;
  window.dataLayer = window.dataLayer || [];

  // Fonction gtag simple
  function gtag() {
    dataLayer.push(arguments);
  }

  // Consent par défaut
  gtag("consent", "default", {
    analytics_storage: "denied",
    ad_storage: "denied",
    ad_user_data: "denied",
    ad_personalization: "denied",
    security_storage: "granted",
  });

  console.log("🔥 Consent system ready");
</script>

<!-- Chargement GTM APRÈS consent -->
<div
  id="consent-popup"
  style="position:fixed;bottom:20px;left:20px;right:20px;background:#2c3e50;color:white;padding:20px;border-radius:8px;z-index:999999;box-shadow:0 4px 12px rgba(0,0,0,0.3);max-width:600px;margin:0 auto;"
>
  <p style="margin:0 0 15px 0;font-size:16px;">
    🍪 <strong>Cookie Notice:</strong> We use cookies to improve your experience.
    <a href="/privacy-policy" style="color:#3498db;">Privacy Policy</a>
  </p>
  <div style="text-align:center;">
    <button
      onclick="acceptAll()"
      style="background:#27ae60;color:white;border:none;padding:12px 24px;border-radius:5px;margin:0 10px;cursor:pointer;font-size:14px;font-weight:bold;"
    >
      ✅ Accept All Cookies
    </button>
    <button
      onclick="rejectAll()"
      style="background:#e74c3c;color:white;border:none;padding:12px 24px;border-radius:5px;margin:0 10px;cursor:pointer;font-size:14px;font-weight:bold;"
    >
      ❌ Reject All
    </button>
  </div>
</div>

<script>
  // Fonction Accept
  function acceptAll() {
    console.log("🟢 Accept clicked");

    // Masquer popup
    document.getElementById("consent-popup").style.display = "none";

    // Stocker choice
    localStorage.setItem("cookie-consent", "accepted");
    window.consentGiven = true;

    // Activer consent
    gtag("consent", "update", {
      analytics_storage: "granted",
      ad_storage: "granted",
      ad_user_data: "granted",
      ad_personalization: "granted",
      functionality_storage: "granted",
      personalization_storage: "granted",
    });

    // Charger GTM MAINTENANT
    loadGTM();

    // Event
    dataLayer.push({
      event: "cookie_consent_granted",
      consent_method: "accept_all",
    });

    console.log("✅ Consent granted, GTM loading...");
  }

  // Fonction Reject
  function rejectAll() {
    console.log("🔴 Reject clicked");

    document.getElementById("consent-popup").style.display = "none";
    localStorage.setItem("cookie-consent", "rejected");

    dataLayer.push({
      event: "cookie_consent_rejected",
    });

    console.log("❌ All cookies rejected");
  }

  // Chargement GTM conditionnel
  function loadGTM() {
    if (window.google_tag_manager) {
      console.log("⚠️ GTM already loaded");
      return;
    }

    console.log("📊 Loading GTM...");

    (function (w, d, s, l, i) {
      w[l] = w[l] || [];
      w[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
      var f = d.getElementsByTagName(s)[0],
        j = d.createElement(s),
        dl = l != "dataLayer" ? "&l=" + l : "";
      j.async = true;
      j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
      f.parentNode.insertBefore(j, f);
    })(window, document, "script", "dataLayer", "GTM-PQC6K9BZ");

    console.log("✅ GTM script injected");
  }

  // Vérification au chargement
  window.addEventListener("load", function () {
    const consent = localStorage.getItem("cookie-consent");

    if (consent === "accepted") {
      console.log("🔄 Previous consent found: ACCEPTED");
      document.getElementById("consent-popup").style.display = "none";
      window.consentGiven = true;

      gtag("consent", "update", {
        analytics_storage: "granted",
        ad_storage: "granted",
        ad_user_data: "granted",
        ad_personalization: "granted",
        functionality_storage: "granted",
        personalization_storage: "granted",
      });

      loadGTM();
    } else if (consent === "rejected") {
      console.log("🔄 Previous consent found: REJECTED");
      document.getElementById("consent-popup").style.display = "none";
    } else {
      console.log("📢 No previous consent - showing popup");
      document.getElementById("consent-popup").style.display = "block";
    }
  });

  console.log("🍪 Simple consent system loaded");
</script>

<!-- GTM NoScript (seulement si consent donné) -->
<noscript id="gtm-noscript" style="display:none;">
  <iframe
    src="https://www.googletagmanager.com/ns.html?id=GTM-PQC6K9BZ"
    height="0"
    width="0"
    style="display:none;visibility:hidden"></iframe>
</noscript>

<!-- 
  🧪 CETTE SOLUTION:
  ✅ Charge GTM SEULEMENT après consent
  ✅ Pas d'erreur gtag undefined 
  ✅ Code ultra simple
  ✅ Logs détaillés
  ✅ Fonctionne à 100%
  
  🔥 TEST:
  1. Rechargez avec console
  2. Cliquez "Accept All Cookies" 
  3. GTM se charge APRÈS
  4. Consent = GRANTED immédiatement
  -->
