<!-- Bannière de consentement avec AdSense retardé au scroll -->
<div
  id="consent-banner"
  style="
  position: fixed; 
  bottom: 0; 
  left: 0; 
  right: 0; 
  background: #1a1a1a; 
  color: white; 
  padding: 1rem; 
  z-index: 10000;
  display: none;
"
>
  <div
    style="max-width: 1200px; margin: 0 auto; display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;"
  >
    <p style="margin: 0; flex: 1; min-width: 200px;">
      We use cookies to improve your experience.
    </p>
    <div style="display: flex; gap: 0.5rem;">
      <button
        id="consent-accept"
        style="
        background: #16a34a; 
        color: white; 
        border: none; 
        padding: 0.5rem 1rem; 
        border-radius: 4px; 
        cursor: pointer;
      "
        >Accept All</button
      >
      <button
        id="consent-reject"
        style="
        background: #dc2626; 
        color: white; 
        border: none; 
        padding: 0.5rem 1rem; 
        border-radius: 4px; 
        cursor: pointer;
      "
        >Reject All</button
      >
    </div>
  </div>
</div>

<script is:inline>
  (function () {
    "use strict";

    // Configuration
    const COOKIE_NAME = "user-consent";
    const COOKIE_DURATION = 365;

    // GTM Setup
    window.dataLayer = window.dataLayer || [];
    function gtag() {
      dataLayer.push(arguments);
    }

    // Consentement par défaut (refusé)
    gtag("consent", "default", {
      analytics_storage: "denied",
      ad_storage: "denied",
      functionality_storage: "denied",
      personalization_storage: "denied",
      ad_user_data: "denied",
      ad_personalization: "denied",
      security_storage: "granted",
    });

    // Fonctions utilitaires
    function setCookie(name, value, days) {
      const expires = new Date(Date.now() + days * 864e5).toUTCString();
      document.cookie = `${name}=${value}; expires=${expires}; path=/; SameSite=Lax`;
    }

    function getCookie(name) {
      return document.cookie
        .split("; ")
        .find((row) => row.startsWith(name + "="))
        ?.split("=")[1];
    }

    function hideBanner() {
      const banner = document.getElementById("consent-banner");
      if (banner) banner.style.display = "none";
    }

    function showBanner() {
      const banner = document.getElementById("consent-banner");
      if (banner) banner.style.display = "block";
    }

    // ✅ SOLUTION RADICALE : AdSense seulement au premier scroll
    let adSenseActivated = false;
    let consentGiven = false;

    function activateAdSenseOnScroll() {
      if (adSenseActivated || !consentGiven) return;

      const scrollHandler = () => {
        if (window.scrollY > 100) {
          // Après 100px de scroll
          adSenseActivated = true;
          window.removeEventListener("scroll", scrollHandler);

          console.log("🚀 User scrolled - loading AdSense now...");
          loadAdSense();
        }
      };

      // Écouter le scroll
      window.addEventListener("scroll", scrollHandler, { passive: true });

      // Backup : charger après 5 secondes même sans scroll
      setTimeout(() => {
        if (!adSenseActivated && consentGiven) {
          console.log("🚀 Timeout - loading AdSense...");
          scrollHandler();
        }
      }, 5000);
    }

    function loadAdSense() {
      if (window.adSenseLoaded) return;

      console.log("📥 Loading AdSense script...");

      const script = document.createElement("script");
      script.src =
        "https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1113800966089168";
      script.async = true;
      script.crossOrigin = "anonymous";

      script.onload = () => {
        window.adSenseLoaded = true;
        console.log("✅ AdSense loaded - initializing ads...");

        // Initialiser toutes les pubs existantes
        const ads = document.querySelectorAll("ins.adsbygoogle");
        ads.forEach(() => {
          try {
            (window.adsbygoogle = window.adsbygoogle || []).push({});
          } catch (e) {
            console.error("AdSense push error:", e);
          }
        });
      };

      script.onerror = () => {
        console.error("❌ AdSense failed to load");
      };

      document.head.appendChild(script);
    }

    // Chargement des services (ULTRA-SIMPLIFIÉ)
    function loadServices() {
      console.log("🚀 Loading GTM...");

      // GTM uniquement (immédiat)
      if (!window.gtmLoaded) {
        (function (w, d, s, l, i) {
          w[l] = w[l] || [];
          w[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
          var f = d.getElementsByTagName(s)[0],
            j = d.createElement(s),
            dl = l != "dataLayer" ? "&l=" + l : "";
          j.async = true;
          j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
          f.parentNode.insertBefore(j, f);
        })(window, document, "script", "dataLayer", "GTM-PQC6K9BZ");
        window.gtmLoaded = true;
      }

      // AdSense : SEULEMENT au scroll (pas maintenant)
      console.log("📋 AdSense will load on user scroll...");
      activateAdSenseOnScroll();
    }

    // Gestion du consentement
    function handleConsent(accepted) {
      setCookie(
        COOKIE_NAME,
        accepted ? "accepted" : "rejected",
        COOKIE_DURATION,
      );
      hideBanner();

      if (accepted) {
        consentGiven = true;

        gtag("consent", "update", {
          analytics_storage: "granted",
          ad_storage: "granted",
          functionality_storage: "granted",
          personalization_storage: "granted",
          ad_user_data: "granted",
          ad_personalization: "granted",
        });

        loadServices();

        dataLayer.push({
          event: "consent_granted",
          page_path: window.location.pathname,
        });

        console.log("✅ Consent accepted - services will load on scroll");
      } else {
        dataLayer.push({
          event: "consent_rejected",
          page_path: window.location.pathname,
        });
        console.log("❌ Consent rejected");
      }
    }

    // Initialisation
    function init() {
      const consent = getCookie(COOKIE_NAME);

      if (consent === "accepted") {
        consentGiven = true;
        handleConsent(true);
      } else if (consent === "rejected") {
        console.log("ℹ️ Consent previously rejected");
      } else {
        showBanner();
      }

      // Event listeners
      const acceptBtn = document.getElementById("consent-accept");
      const rejectBtn = document.getElementById("consent-reject");

      if (acceptBtn) {
        acceptBtn.addEventListener("click", () => handleConsent(true));
      }

      if (rejectBtn) {
        rejectBtn.addEventListener("click", () => handleConsent(false));
      }
    }

    // Démarrage
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", init);
    } else {
      init();
    }
  })();
</script>

<!-- GTM noscript fallback -->
<noscript>
  <iframe
    src="https://www.googletagmanager.com/ns.html?id=GTM-PQC6K9BZ"
    height="0"
    width="0"
    style="display:none;visibility:hidden"></iframe>
</noscript>
