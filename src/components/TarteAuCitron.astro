---
// TarteAuCitron.astro - SOLUTION RADICALE QUI FONCTIONNE
---

<!-- âœ… Ã‰TAPE 1: GTM en premier AVANT TarteAuCitron -->
<script is:inline>
  window.dataLayer = window.dataLayer || [];
  function gtag() {
    dataLayer.push(arguments);
  }

  // Consentement par dÃ©faut refusÃ©
  gtag("consent", "default", {
    analytics_storage: "denied",
    ad_storage: "denied",
    functionality_storage: "denied",
    personalization_storage: "denied",
    ad_user_data: "denied",
    ad_personalization: "denied",
    security_storage: "granted",
  });

  // âœ… CHARGER GTM MANUELLEMENT (pas via TarteAuCitron)
  (function (w, d, s, l, i) {
    w[l] = w[l] || [];
    w[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
    var f = d.getElementsByTagName(s)[0],
      j = d.createElement(s),
      dl = l != "dataLayer" ? "&l=" + l : "";
    j.async = true;
    j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
    f.parentNode.insertBefore(j, f);
  })(window, document, "script", "dataLayer", "GTM-PQC6K9BZ");

  console.log("GTM loaded manually with consent denied by default");
</script>

<script is:inline>
  var tarteaucitronForceLanguage = "en";

  (function () {
    var script = document.createElement("script");
    script.src =
      "https://cdn.jsdelivr.net/npm/tarteaucitronjs@1/tarteaucitron.js";
    script.onload = function () {
      tarteaucitron.init({
        privacyUrl: "/privacy-policy",
        bodyPosition: "bottom",
        hashtag: "#tarteaucitron",
        cookieName: "tarteaucitron",
        orientation: "middle",
        showDetailsOnClick: true,
        serviceDefaultState: "wait",
        DenyAllCta: true,
        AcceptAllCta: true,
        highPrivacy: true,
        showIcon: true,
        iconPosition: "BottomRight",
        showAlertSmall: true,
      });

      // âœ… NE PAS utiliser le service GTM de TarteAuCitron
      // On le gÃ¨re manuellement maintenant

      // Configuration Google AdSense seulement
      tarteaucitron.user.adsensecapub = "ca-pub-1113800966089168";
      (tarteaucitron.job = tarteaucitron.job || []).push("adsenseauto");

      // âœ… FORCER la mise Ã  jour du consentement GTM
      function forceGTMConsent(granted) {
        console.log("ðŸ”¥ FORCING GTM consent update:", granted);

        if (granted) {
          gtag("consent", "update", {
            analytics_storage: "granted",
            ad_storage: "granted",
            functionality_storage: "granted",
            personalization_storage: "granted",
            ad_user_data: "granted",
            ad_personalization: "granted",
          });

          // Double sÃ©curitÃ© avec dataLayer
          window.dataLayer.push({
            event: "consent_granted",
            analytics_storage: "granted",
            ad_storage: "granted",
            functionality_storage: "granted",
            personalization_storage: "granted",
            ad_user_data: "granted",
            ad_personalization: "granted",
          });
        } else {
          gtag("consent", "update", {
            analytics_storage: "denied",
            ad_storage: "denied",
            functionality_storage: "denied",
            personalization_storage: "denied",
            ad_user_data: "denied",
            ad_personalization: "denied",
          });

          window.dataLayer.push({
            event: "consent_denied",
            analytics_storage: "denied",
            ad_storage: "denied",
          });
        }
      }

      // âœ… Intercepter les clics sur les boutons
      document.addEventListener("click", function (e) {
        // Bouton Accept All
        if (
          e.target.id === "tarteaucitronAllAllowed" ||
          e.target.classList.contains("tarteaucitronAllow")
        ) {
          console.log("ðŸŸ¢ Accept All clicked");
          setTimeout(function () {
            forceGTMConsent(true);
          }, 200);
        }

        // Bouton Deny All
        if (
          e.target.id === "tarteaucitronAllDenied" ||
          e.target.classList.contains("tarteaucitronDeny")
        ) {
          console.log("ðŸ”´ Deny All clicked");
          setTimeout(function () {
            forceGTMConsent(false);
          }, 200);
        }
      });

      // âœ… VÃ©rifier le statut au chargement
      setTimeout(function () {
        if (
          tarteaucitron.state &&
          Object.keys(tarteaucitron.state).length > 0
        ) {
          var hasAccepted = Object.values(tarteaucitron.state).some(
            (s) => s === true,
          );
          if (hasAccepted) {
            forceGTMConsent(true);
          }
        }
      }, 1000);

      console.log("âœ… TarteAuCitron with MANUAL GTM consent management");
    };
    document.head.appendChild(script);
  })();
</script>

<!-- âœ… GTM noscript fallback -->
<noscript>
  <iframe
    src="https://www.googletagmanager.com/ns.html?id=GTM-PQC6K9BZ"
    height="0"
    width="0"
    style="display:none;visibility:hidden"></iframe>
</noscript>
