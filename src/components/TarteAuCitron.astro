---
// TarteAuCitron optimis√© - Chargement s√©lectif des services
---

<script is:inline>
  // √âviter les doubles chargements
  if (!window.tarteaucitronOptimized) {
    window.tarteaucitronOptimized = true;

    // GTM Setup avec consent mode
    window.dataLayer = window.dataLayer || [];
    function gtag() {
      dataLayer.push(arguments);
    }

    // Configuration consent par d√©faut
    gtag("consent", "default", {
      analytics_storage: "denied",
      ad_storage: "denied",
      functionality_storage: "denied",
      personalization_storage: "denied",
      ad_user_data: "denied",
      ad_personalization: "denied",
      security_storage: "granted",
    });

    // Fonction de chargement intelligent des services
    function loadConsentManager() {
      // Chargement SEULEMENT du core TarteAuCitron (sans services.min.js)
      const script = document.createElement("script");
      script.src =
        "https://cdn.jsdelivr.net/npm/tarteaucitronjs@1/tarteaucitron.js";

      script.onload = function () {
        console.log("üç™ TarteAuCitron core loaded");

        // Configuration minimale
        tarteaucitron.init({
          privacyUrl: "/privacy-policy",
          bodyPosition: "bottom",
          hashtag: "#tarteaucitron",
          cookieName: "tarteaucitron",
          orientation: "middle",
          showDetailsOnClick: true,
          serviceDefaultState: "wait",
          DenyAllCta: true,
          AcceptAllCta: true,
          highPrivacy: true,
          showIcon: true,
          iconPosition: "BottomRight",
          showAlertSmall: true,
        });

        // ‚úÖ SERVICES MANUELS - Seulement ce dont vous avez besoin

        // 1. Google Tag Manager manuel
        (tarteaucitron.services = tarteaucitron.services || {}).gtm = {
          key: "gtm",
          type: "analytic",
          name: "Google Tag Manager",
          uri: "https://policies.google.com/privacy",
          needConsent: true,
          cookies: ["_ga", "_gat", "_gid"],
          js: function () {
            if (!window.gtmLoaded) {
              window.gtmLoaded = true;
              (function (w, d, s, l, i) {
                w[l] = w[l] || [];
                w[l].push({
                  "gtm.start": new Date().getTime(),
                  event: "gtm.js",
                });
                var f = d.getElementsByTagName(s)[0],
                  j = d.createElement(s),
                  dl = l != "dataLayer" ? "&l=" + l : "";
                j.async = true;
                j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
                f.parentNode.insertBefore(j, f);
              })(window, document, "script", "dataLayer", "GTM-PQC6K9BZ");

              console.log("‚úÖ GTM loaded via consent");
            }
          },
          fallback: function () {
            console.log("‚ùå GTM blocked by user");
          },
        };

        // 2. AdSense manuel
        (tarteaucitron.services = tarteaucitron.services || {}).adsense = {
          key: "adsense",
          type: "ads",
          name: "Google AdSense",
          uri: "https://policies.google.com/privacy",
          needConsent: true,
          cookies: ["_gcl_au"],
          js: function () {
            if (!window.adsenseLoaded) {
              window.adsenseLoaded = true;
              const script = document.createElement("script");
              script.async = true;
              script.src =
                "https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1113800966089168";
              script.crossOrigin = "anonymous";
              document.head.appendChild(script);

              console.log("‚úÖ AdSense loaded via consent");
            }
          },
          fallback: function () {
            console.log("‚ùå AdSense blocked by user");
          },
        };

        // Ajouter les services √† la job queue
        tarteaucitron.user.gtmId = "GTM-PQC6K9BZ";
        tarteaucitron.user.adsensePubId = "ca-pub-1113800966089168";

        (tarteaucitron.job = tarteaucitron.job || []).push("gtm", "adsense");

        // Gestion globale du consentement
        function updateGlobalConsent(granted) {
          console.log("üåç Consent update:", granted);

          if (granted) {
            gtag("consent", "update", {
              analytics_storage: "granted",
              ad_storage: "granted",
              functionality_storage: "granted",
              personalization_storage: "granted",
              ad_user_data: "granted",
              ad_personalization: "granted",
            });

            window.dataLayer.push({
              event: "consent_granted",
              page_path: window.location.pathname,
            });
          } else {
            gtag("consent", "update", {
              analytics_storage: "denied",
              ad_storage: "denied",
              functionality_storage: "denied",
              personalization_storage: "denied",
              ad_user_data: "denied",
              ad_personalization: "denied",
            });
          }
        }

        // √âcouter les interactions de consentement
        document.addEventListener("click", function (e) {
          if (
            e.target.id === "tarteaucitronAllAllowed" ||
            e.target.closest("#tarteaucitronAllAllowed")
          ) {
            setTimeout(() => updateGlobalConsent(true), 500);
          }

          if (
            e.target.id === "tarteaucitronAllDenied" ||
            e.target.closest("#tarteaucitronAllDenied")
          ) {
            setTimeout(() => updateGlobalConsent(false), 500);
          }
        });

        // V√©rifier l'√©tat existant
        setTimeout(() => {
          if (
            tarteaucitron.state &&
            Object.keys(tarteaucitron.state).length > 0
          ) {
            const hasAccepted = Object.values(tarteaucitron.state).some(
              (s) => s === true,
            );
            if (hasAccepted) {
              updateGlobalConsent(true);
            }
          }
        }, 1000);

        console.log("‚úÖ Optimized consent system ready");
      };

      script.onerror = function () {
        console.error("‚ùå Failed to load consent system");
      };

      document.head.appendChild(script);
    }

    // Chargement diff√©r√© du gestionnaire de consentement
    function initConsentSystem() {
      // Chargement apr√®s interaction ou 2 secondes
      let loaded = false;

      function load() {
        if (!loaded) {
          loaded = true;
          loadConsentManager();
        }
      }

      // D√©clencheurs d'interaction
      ["scroll", "click", "touchstart", "keydown"].forEach((event) => {
        document.addEventListener(event, load, { once: true });
      });

      // Fallback apr√®s 2 secondes
      setTimeout(load, 2000);
    }

    // Initialiser quand le DOM est pr√™t
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initConsentSystem);
    } else {
      initConsentSystem();
    }
  }
</script>

<!-- GTM noscript fallback -->
<noscript>
  <iframe
    src="https://www.googletagmanager.com/ns.html?id=GTM-PQC6K9BZ"
    height="0"
    width="0"
    style="display:none;visibility:hidden"></iframe>
</noscript>
