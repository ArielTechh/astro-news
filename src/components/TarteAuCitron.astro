---
// TarteAuCitron.astro - SOLUTION DÃ‰FINITIVE CORRIGÃ‰E
---

<script is:inline>
  var tarteaucitronForceLanguage = "en";

  (function () {
    var script = document.createElement("script");
    script.src =
      "https://cdn.jsdelivr.net/npm/tarteaucitronjs@1/tarteaucitron.js";
    script.onload = function () {
      tarteaucitron.init({
        privacyUrl: "/privacy-policy",
        bodyPosition: "bottom",
        hashtag: "#tarteaucitron",
        cookieName: "tarteaucitron",
        orientation: "middle",
        showDetailsOnClick: true,
        serviceDefaultState: "wait",
        DenyAllCta: true,
        AcceptAllCta: true,
        highPrivacy: true,
        showIcon: true,
        iconPosition: "BottomRight",
        showAlertSmall: true,
      });

      // âœ… Configuration GTM
      tarteaucitron.user.googletagmanagerId = "GTM-PQC6K9BZ";
      (tarteaucitron.job = tarteaucitron.job || []).push("googletagmanager");

      // âœ… Configuration Google AdSense
      tarteaucitron.user.adsensecapub = "ca-pub-1113800966089168";
      (tarteaucitron.job = tarteaucitron.job || []).push("adsenseauto");

      // âœ… SOLUTION : Forcer la mise Ã  jour du consentement aprÃ¨s acceptation
      tarteaucitron.userInterface.respondAll = function (status) {
        var s = tarteaucitron.services;
        for (var i = 0; i < s.length; i += 1) {
          if (s[i].name !== undefined) {
            if (status === true) {
              tarteaucitron.userInterface.respond(s[i], true);
            } else if (status === false) {
              tarteaucitron.userInterface.respond(s[i], false);
            }
          }
        }

        // ðŸ”¥ FORCER LA MISE Ã€ JOUR GTM
        if (status === true && window.dataLayer) {
          window.dataLayer.push({
            event: "consent_update",
            "gtm.consent": "granted",
            analytics_storage: "granted",
            ad_storage: "granted",
            functionality_storage: "granted",
            personalization_storage: "granted",
            security_storage: "granted",
          });
          console.log("âœ… Consent updated in GTM DataLayer");
        }
      };

      // âœ… Initialiser le consentement par dÃ©faut pour GTM
      if (window.gtag) {
        gtag("consent", "default", {
          analytics_storage: "denied",
          ad_storage: "denied",
          functionality_storage: "denied",
          personalization_storage: "denied",
          security_storage: "granted",
        });
      }

      console.log("TarteAuCitron initialized with GTM consent fix");
    };
    document.head.appendChild(script);
  })();
</script>

<!-- âœ… GTM Container (se charge aprÃ¨s consentement) -->
<script is:inline>
  window.dataLayer = window.dataLayer || [];
  function gtag() {
    dataLayer.push(arguments);
  }

  // Consentement par dÃ©faut refusÃ©
  gtag("consent", "default", {
    analytics_storage: "denied",
    ad_storage: "denied",
    functionality_storage: "denied",
    personalization_storage: "denied",
    security_storage: "granted",
  });
</script>
