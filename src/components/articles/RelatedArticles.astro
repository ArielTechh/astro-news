---
// src/components/articles/RelatedArticles.astro
import { getAllArticles, urlFor } from "@/lib/sanity";

interface Props {
  currentArticle: any;
}

const { currentArticle } = Astro.props;

// Récupérer tous les articles
const allArticles = await getAllArticles();
const otherArticles = allArticles.filter(
  (article) => article._id !== currentArticle._id,
);

// Chercher les articles de même catégorie
let relatedArticles = [];

if (currentArticle.categories && currentArticle.categories.length > 0) {
  const currentCategoryIds = currentArticle.categories.map((cat) => cat._id);

  relatedArticles = otherArticles.filter((article) => {
    if (!article.categories) return false;
    return article.categories.some((cat) =>
      currentCategoryIds.includes(cat._id),
    );
  });
}

// Si pas assez d'articles par catégorie, compléter avec les plus récents
if (relatedArticles.length < 3) {
  const recentArticles = otherArticles
    .filter(
      (article) =>
        !relatedArticles.some((related) => related._id === article._id),
    )
    .sort((a, b) => new Date(b.publishedTime) - new Date(a.publishedTime))
    .slice(0, 3 - relatedArticles.length);

  relatedArticles = [...relatedArticles, ...recentArticles];
}

// Limiter à 3 articles
relatedArticles = relatedArticles.slice(0, 3);

// Si aucun article, ne pas afficher la section
if (relatedArticles.length === 0) {
  return null;
}

// Fonction pour formater la date en hébreu
const formatDate = (dateString: string) => {
  return new Date(dateString).toLocaleDateString("he-IL", {
    day: "numeric",
    month: "long",
    year: "numeric",
  });
};
---

<section
  class="mt-16 border-t border-gray-200 dark:border-gray-700 pt-12"
  aria-labelledby="related-articles-title"
  dir="rtl"
>
  <div class="container mx-auto px-4 max-w-5xl">
    <header class="mb-8">
      <h2
        id="related-articles-title"
        class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-gray-100 mb-2"
      >
        מאמרים דומים
      </h2>
      <p class="text-gray-600 dark:text-gray-400 text-sm">
        גלו מאמרים נוספים שעשויים לעניין אתכם
      </p>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {
        relatedArticles.map((article) => {
          const imageUrl = article.cover
            ? urlFor(article.cover)
                .width(400)
                .height(250)
                .quality(85)
                .format("webp")
                .url()
            : null;

          return (
            <article
              key={article._id}
              class="group bg-white dark:bg-gray-800 rounded-xl shadow-sm hover:shadow-lg transition-all duration-300 border border-gray-100 dark:border-gray-700 hover:border-gray-200 dark:hover:border-gray-600"
            >
              <a
                href={`/${article.slug.current}`}
                class="block"
                aria-label={`קרא את המאמר: ${article.title}`}
              >
                {imageUrl && (
                  <div class="relative overflow-hidden aspect-video rounded-t-xl">
                    <img
                      src={imageUrl}
                      alt={article.cover?.alt || article.title}
                      class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                      loading="lazy"
                      width="400"
                      height="250"
                      decoding="async"
                    />

                    {/* Badge pour les articles headlines */}
                    {(article.isMainHeadline || article.isSubHeadline) && (
                      <div class="absolute top-2 right-2">
                        <span class="bg-red-500 text-white text-xs font-semibold px-2 py-1 rounded-full">
                          ⭐ כותרת ראשית
                        </span>
                      </div>
                    )}
                  </div>
                )}

                <div class="p-4">
                  {/* Catégories */}
                  {article.categories && article.categories.length > 0 && (
                    <div class="flex flex-wrap gap-1 mb-2 justify-end">
                      {article.categories.slice(0, 2).map((category) => (
                        <span
                          key={category._id}
                          class="inline-block bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 text-xs font-medium px-2 py-1 rounded-full"
                        >
                          {category.title}
                        </span>
                      ))}
                    </div>
                  )}

                  <h3 class="font-semibold text-lg text-gray-900 dark:text-gray-100 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors line-clamp-2 mb-2 text-right">
                    {article.title}
                  </h3>

                  {article.description && (
                    <p class="text-gray-600 dark:text-gray-400 text-sm line-clamp-2 mb-3 text-right">
                      {article.description}
                    </p>
                  )}

                  {/* Métadonnées */}
                  <div class="flex items-center gap-3 text-xs text-gray-500 dark:text-gray-400 justify-end">
                    <time datetime={article.publishedTime}>
                      {formatDate(article.publishedTime)}
                    </time>

                    {article.authors && article.authors.length > 0 && (
                      <>
                        <span>•</span>
                        <span>מאת {article.authors[0].name}</span>
                      </>
                    )}

                    {article.tags && article.tags.length > 0 && (
                      <>
                        <span>•</span>
                        <span class="line-clamp-1">
                          #{article.tags.slice(0, 2).join(", #")}
                        </span>
                      </>
                    )}
                  </div>
                </div>
              </a>
            </article>
          );
        })
      }
    </div>
  </div>
</section>

<style>
  .line-clamp-1 {
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
